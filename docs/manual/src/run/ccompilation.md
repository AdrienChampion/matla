# Debug/release: conditional compilation

> This chapter builds on the toy project discussed in the [previous chapter](../project). It might
> be useful to be familiar with it, especially if this is your first time reading this.

Matla's conditional compilation is tied to the [`Matla` module discussed in the previous
chapter](../project/layout.md#the-matla-module). If you remember, `Matla.tla` is generated by
`matla init` among your project's sources.

Just like we did back then, let's pretend this module only defines `assert` and none of its
variants, all of which are handled the same by matla's conditional compilation anyway.

```text
> cat Matla.tla
---- MODULE Matla ----
\* Matla helpers, mostly for assertions and debug/release conditional compilation.

\* TLC!Assertions are built on top of the standard `TLC' module.
LOCAL TLC == INSTANCE TLC
---- MODULE dbg ----
\* All functions in this module do nothing in `release' mode.

\* Checks some predicate.
assert(
    \* Predicate that must be true.
    pred,
    \* Message issued when the predicate is false.
    message
) ==
    TLC!Assert(pred, message)

====
\* End of module `dbg'.

\* Contains debug-only functions.
dbg == INSTANCE dbg

\* Checks some predicate.
\*
\* Active in debug and release.
assert(
    \* Predicate that must be true.
    pred,
    \* Message issued when the predicate is false.
    message
) ==
    TLC!Assert(pred, message)

====
\* End of module `Matla'.
```

The two versions, `Matla!assert` and `Matla!dbg!assert`, behave exactly the same in `debug` mode,
which is `matla run`'s default mode. They differ in `release` mode however, activated by `matla run
--release`, in that `Matla!dbg!assert`s will be compiled away (replaced by `TRUE`) while
`Matla!assert`s will still cause TLC to check them, and fail if they do not hold.

</br>

Let's illustrate this on our running stopwatch project, sources available [here][run/cc1].

```text
> exa
Matla.tla  Matla.toml  sw_0.cfg  sw_0.tla  target

> bat sw_0.cfg
───────┬────────────────────────────────────────────────────────────────────────
       │ File: sw_0.cfg
───────┼────────────────────────────────────────────────────────────────────────
   1   │ INIT init
   2   │ NEXT next
   3   │
   4   │ INVARIANTS
   5   │     inv_cnt_pos
   6   │     inv_reset
───────┴────────────────────────────────────────────────────────────────────────
```

Module `sw_0` defines a `next` action:

```text
> bat -r 17:27 sw_0.tla
───────┬────────────────────────────────────────────────────────────────────────
       │ File: sw_0.tla
───────┼────────────────────────────────────────────────────────────────────────
  17   │ next ==
  18   │     bool(reset')
  19   │     /\ bool(start_stop')
  20   │     /\ (
  21   │         IF start_stop' THEN counting' = ~counting
  22   │         ELSE UNCHANGED counting
  23   │     ) /\ (
  24   │         IF reset' THEN cnt' = 0
  25   │         ELSE IF counting' /\ cnt < 59 THEN cnt' = cnt + 1
  26   │         ELSE UNCHANGED cnt
  27   │     )
───────┴────────────────────────────────────────────────────────────────────────
```

Let's add a non-debug check that we expect to fail:

```text
> bat -r 17:29 sw_0.tla
───────┬────────────────────────────────────────────────────────────────────────
       │ File: sw_0.tla
───────┼────────────────────────────────────────────────────────────────────────
  17 ~ │ LOCAL Matla == INSTANCE Matla
  18   │ next ==
  19   │     bool(reset')
  20   │     /\ bool(start_stop')
  21 + │     /\ Matla!assert(reset')
  22   │     /\ (
  23   │         IF start_stop' THEN counting' = ~counting
  24   │         ELSE UNCHANGED counting
  25   │     ) /\ (
  26   │         IF reset' THEN cnt' = 0
  27   │         ELSE IF counting' /\ cnt < 59 THEN cnt' = cnt + 1
  28   │         ELSE UNCHANGED cnt
  29   │     )
───────┴────────────────────────────────────────────────────────────────────────
```

</br>

Running matla again, we get

```
{{ #include code/cond_comp_1.test:3: }}
```

</br>

Let's make sure `debug`/`release` modes work for `Matla!dbg!assert`. Project sources available
[here][run/cc2].

```text
> bat -r 17:29 sw_0.tla
───────┬────────────────────────────────────────────────────────────────────────
       │ File: sw_0.tla
───────┼────────────────────────────────────────────────────────────────────────
  17   │ LOCAL Matla == INSTANCE Matla
  18   │ next ==
  19   │     bool(reset')
  20   │     /\ bool(start_stop')
  21 ~ │     /\ Matla!dbg!assert(reset')
  22   │     /\ (
  23   │         IF start_stop' THEN counting' = ~counting
  24   │         ELSE UNCHANGED counting
  25   │     ) /\ (
  26   │         IF reset' THEN cnt' = 0
  27   │         ELSE IF counting' /\ cnt < 59 THEN cnt' = cnt + 1
  28   │         ELSE UNCHANGED cnt
  29   │     )
───────┴────────────────────────────────────────────────────────────────────────
```

</br>

Running in `debug` mode (without `--release`) should still fail:

```text
{{ #include code/cond_comp_2.debug.test:1 }}
{{ #include code/cond_comp_2.debug.test:3: }}
```

</br>

Running in `release` mode should succeed however, since besides the assertion line `21` the
specification is *safe*:

```text
{{ #include code/cond_comp_2.release.test:1 }}
{{ #include code/cond_comp_2.release.test:3: }}
```

[run/cc1]: https://github.com/OCamlPro/matla/tree/latest/docs/manual/src/run/code/cond_comp_1
[run/cc2]: https://github.com/OCamlPro/matla/tree/latest/docs/manual/src/run/code/cond_comp_2
